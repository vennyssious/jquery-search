$.fn.metaSearch=function(args){var E={};E.inpt=$(this);var el_id=void 0!==E.inpt.attr("id")?"#"+E.inpt.attr("id"):"[name="+E.inpt.attr("name")+"]",init=function(){if(args.fields=M.filter(args.fields,function(a){return""!==a}),E.inpt.hide(),E.inpt.wrap('<div class="search-wrap" data-target="'+el_id+'"></div>'),E.wrap=E.inpt.parent(".search-wrap"),E.wrap.fake=$("<div/>",{class:"search-wrap-fake"}),E.wrap.fake.field=$("<div/>",{class:"search-use-field"}),E.wrap.fake.el=$("<div/>",{class:"search-fake",contenteditable:"true"}),E.wrap.res=$("<div/>",{class:"search-res"}),E.wrap.suggest=$("<div/>",{class:"search-suggest",style:"display: none;"}),E.wrap.fake.el.keypress(function(a){if(13==a.which)return""===E.wrap.fake.el.html()||priv.choosing||M.do_search.apply(this,[a]),priv.choosing=!1,!1}),E.wrap.fake.el.keydown(function(a){if(38==a.which&&priv.canChoose){var b=E.wrap.suggest.find(".search-field"),c=b.last(),d=E.wrap.suggest.find(".selected").length>0?E.wrap.suggest.find(".selected"):c;b.removeClass("selected"),0==d.prev().length?c.addClass("selected"):d.prev().addClass("selected"),priv.choosing=!0}else if(40==a.which&&priv.canChoose){var b=E.wrap.suggest.find(".search-field"),e=b.first(),d=E.wrap.suggest.find(".selected").length>0?E.wrap.suggest.find(".selected"):e;b.removeClass("selected"),0==d.next().length?e.addClass("selected"):d.next().addClass("selected"),priv.choosing=!0}else if(13==a.which&&priv.canChoose){var d=E.wrap.suggest.find(".selected")[0];priv.choosing&&void 0!==d&&M.do_search_with.apply(d,[null])}else 27==a.which?priv.canChoose?(E.wrap.suggest.hide(),priv.canChoose=!1):E.wrap.fake.is(".is-search")&&""==E.wrap.fake.el.html()&&(E.wrap.fake.field.html(""),E.wrap.fake.field.css("visibility","hidden"),E.wrap.fake.removeClass("is-search")):8==a.which&&""==E.wrap.fake.el.html()&&(E.wrap.fake.field.html(""),E.wrap.fake.field.attr("data-label","  "),E.wrap.fake.field.css("visibility","hidden"),E.wrap.fake.removeClass("is-search"))}),E.wrap.fake.el.keyup(function(a){if([38,40,13,27].indexOf(a.which)>-1)return!1;var b=$(this).html().trim();if(!E.wrap.fake.is(".is-search")&&M.is_search(b)){priv.canChoose=!0,M.get_fields.apply(this,[a]);E.wrap.suggest.find(".search-field").first().next().addClass("selected"),priv.choosing=!0}""==b&&(E.wrap.suggest.hide(),priv.canChoose=!1)}),$(document).click(function(a){var b=$(a.target);b.is(".search-opt-wrap, .search-opt-wrap *")||E.wrap.find(".search-opt-wrap").removeClass("opened"),b.is(".search-suggest, .search-suggest *, .search-wrap-fake, .search-fake")?b.is(".search-wrap-fake, .search-fake")&&!E.wrap.fake.is(".is-search")&&M.is_search(E.wrap.fake.el.html().trim())&&M.get_fields(null):(priv.canChoose=!1,E.wrap.suggest.hide())}),E.wrap.fake.field.click(function(a){a.stopPropagation(),M.get_fields.apply(this,[a,!0]),E.wrap.fake.el.focus(),priv.canChoose=!0}),E.wrap.fake.append(E.wrap.fake.field,E.wrap.fake.el),E.wrap.append(E.wrap.fake,E.wrap.suggest,E.wrap.res),void 0!==args.search_opts&&Object.keys(args.search_opts).length>0){E.wrap.addClass("using-options");var search_opts=args.search_opts,options=search_opts.options,selected=search_opts.selected,opts_wrap=$("<div/>",{class:"search-opt-wrap"}),opt_choose=$("<div/>",{class:"search-opt-choose fa fa-chevron-down",html:"<span>&nbsp;</span>"}),opts_field=$("<div/>",{class:"search-opt-fields"}),opts_inpt=$("<input>",{class:"search-opt-inpt",type:"hidden",value:selected,name:args.name+"_opt"});opt_choose.click(function(a){opts_wrap.is(".opened")?opts_wrap.removeClass("opened"):opts_wrap.addClass("opened")}),opts_wrap.append(opt_choose,opts_field),E.wrap.fake.append(opts_wrap),E.wrap.append(opts_inpt),Object.keys(options).length>0&&$.each(options,function(a,b){var c=$("<div/>",{class:"search-opt-field "+(a==selected?"selected":""),html:b.label,"data-value":b.value,"data-key":a});if(c.click(function(b){var c=$(this),d=opt_choose.find("span");d.html(c.attr("data-value")),d.attr("data-label",c.html()),opts_field.find(".search-opt-field").removeClass("selected"),c.addClass("selected"),opts_wrap.removeClass("opened"),opts_inpt.val(a)}),a==selected){var d=opt_choose.find("span");d.html(c.attr("data-value")),d.attr("data-label",c.html()),opts_field.find(".search-opt-field").removeClass("selected"),c.addClass("selected")}opts_field.append(c)})}void 0!==args.search_terms&&Object.keys(args.search_terms).length>0&&$.each(args.search_terms,function(k,v){len=priv.field_id||0;var regexRM=eval("/^\\"+args.keyDispatch+"/"),regexEx=eval("/^\\"+args.keyDispatch+"(.*?):.*/"),field_html,val_html,field_show,prefix="";if(v.match(regexEx)){var field=v.split(":");field_html=field[0].replace(regexRM,""),val_html=field[1],field_show=void 0!==args.fields[field_html]?args.fields[field_html]+": ":field_html+": ",""!==field_html&&(prefix=args.keyDispatch),field_html+=":"}else field_html="",field_show="",val_html=v;var res_child=$("<div/>",{class:"search-res-child","data-label":field_html,"data-val":val_html,"data-id":len,html:field_show+val_html,title:field_show+val_html}),res_child_rm=$("<i>",{class:"search-res-remove fa fa-times","data-id":len,value:""}),res_child_inpt=$("<input>",{class:"search-res-inpt",type:"hidden",name:args.name+"[]",value:prefix+field_html+val_html,"data-id":len,form:args.form});res_child_rm.click(M.remove_field),res_child.append(res_child_rm),E.wrap.res.append(res_child,res_child_inpt),priv.field_id++})},def_args={fields:{},name:E.inpt.attr("name"),keyDispatch:"+"};if(args=$.extend(def_args,args),void 0!==args.datalist){var datalist_fields={};args.datalist.find("option").each(function(){var a=$(this);datalist_fields[a.val()]=a.html()}),args.fields=datalist_fields}var M={get_fields:function(a,b){b=b||!1;var c="";b||(c=E.wrap.fake.el.html(),c=c.toLowerCase().replace(args.keyDispatch,""));var d=M.get_fields_with(c);E.wrap.suggest.html("");var e=$("<div/>",{class:"search-field search-field-blank","data-label":"Limpar",html:""});e.click(function(a){M.do_search_with.apply(this,[a,b])}),E.wrap.suggest.append(e);for(var f in d){var h,g=d[f];h=$.isArray(d)?$("<div/>",{class:"search-field","data-label":"",html:g+"<span>&nbsp;</span>"}):$("<div/>",{class:"search-field","data-label":g,html:f+"<span>"+g+"</span>"}),h.click(function(a){M.do_search_with.apply(this,[a,b])}),h.mouseenter(function(a){E.wrap.suggest.find(".search-field").removeClass("selected"),$(this).addClass("selected")}),E.wrap.suggest.append(h)}E.wrap.suggest.show()},get_fields_with:function(a){var b=args.fields;if($.isArray(b)){var c=[];for(var d in b){var e=b[d];e.toLowerCase().indexOf(a)>-1&&(a!=args.keyDispatch&&(e=M.mark_field(e,a)),c.push(e))}}else{var c={};for(var d in b){var e=b[d];if(d.toLowerCase().indexOf(a)>-1||e.toLowerCase().indexOf(a)>-1){var f=d,g=e;a!=args.keyDispatch&&(f=M.mark_field(d,a),g=M.mark_field(e,a)),c[f]=g}}}return c},do_search:function(a){var b=(E.wrap.fake.field.html()||"").trim(),c=(E.wrap.fake.el.html()||"").trim(),d=E.wrap.fake.field.attr("data-label")||"",e="",f=priv.field_id,g="";""!==b&&(g=args.keyDispatch),e=""!==d?d+c:b+c;var h=$("<div/>",{class:"search-res-child","data-label":b,"data-val":c,"data-id":f,html:e,title:e}),i=$("<i>",{class:"search-res-remove fa fa-times","data-id":f,value:""}),j=$("<input>",{class:"search-res-inpt",type:"hidden",name:args.name+"[]",value:g+b+c,"data-id":f,form:args.form});i.click(M.remove_field),$(this).html(""),E.wrap.fake.field.html("").css("visibility","hidden"),E.wrap.suggest.hide(),E.wrap.fake.removeClass("is-search"),h.append(i),E.wrap.res.append(h,j),E.wrap.fake.field.attr("data-label",""),priv.canChoose=!1,priv.field_id++},do_search_with:function(a,b){b=b||!1;var c=$(this),d=c.html(),e=c.data("label");""!==d?(E.wrap.fake.field.css("visibility","visible"),E.wrap.fake.field.html(d+": "),""!==e?E.wrap.fake.field.attr("data-label",e+": "):E.wrap.fake.field.attr("data-label",""),E.wrap.fake.addClass("is-search")):(E.wrap.fake.field.css("visibility","hidden"),E.wrap.fake.field.html(""),E.wrap.fake.field.attr("data-label",""),E.wrap.fake.removeClass("is-search")),E.wrap.fake.el.focus(),b||E.wrap.fake.el.html(""),c.parent(".search-suggest").hide(),priv.canChoose=!1},remove_field:function(a){var b=$(this).data("id");E.wrap.res.find('.search-res-child[data-id="'+b+'"]').remove(),E.wrap.res.find('.search-res-inpt[data-id="'+b+'"]').remove()},mark_field:function(a,b){var c=new RegExp("("+b+")","gi");return a.replace(c,"<strong>$1</strong>")},is_search:function(value){var regex=eval("/^\\"+args.keyDispatch+"/");return regex.test(value)},filter:function(a,b){var c=$.isArray(a)?[]:{};for(var d in a)a.hasOwnProperty(d)&&b(a[d])&&($.isArray(a)?c.push(a[d]):c[d]=a[d]);return c},map:function(a,b){var c={};for(var d in a)a.hasOwnProperty(d)&&b(a[d])&&(c[d]=b(d,a[d]));return c}},priv={choosing:!1,canChoose:!1,field_id:0};return String.prototype.capitalize=function(){var a=this;return a=a.toLowerCase().replace(/\b[a-z]/g,function(a){return a.toUpperCase()})},String.prototype.upperFirst=function(){var a=this;return a=a.toLowerCase().replace(/\b[a-z]/,function(a){return a.toUpperCase()})},init()};